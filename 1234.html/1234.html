<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CLD Event Bid App</title>
  <!-- Google Fonts for premium look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-1: #0f172a;
      --bg-2: #1e293b;
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --accent-primary: #3b82f6;
      /* Blue */
      --accent-secondary: #8b5cf6;
      /* Violet */
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
    }

    /* Reset & Base */
    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #1e1b4b, transparent 40%),
        radial-gradient(circle at bottom right, #172554, transparent 40%),
        var(--bg-1);
      background-attachment: fixed;
      /* Parallax-like effect */
      display: flex;
      justify-content: center;
      align-items: center;
      /* Center vertically */
      min-height: 100vh;
    }

    /* Glass Card Container */
    .page {
      display: none;
      width: 100%;
      max-width: 500px;
      /* Default narrow for auth */
      margin: 20px;
      padding: 40px;
      border-radius: 24px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      animation: fadeIn 0.4s ease-out;
    }

    .page.active {
      display: block;
    }

    .page.wide {
      max-width: 1000px;
    }

    /* Wider for content pages */

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typography */
    h2 {
      margin: 0 0 24px 0;
      text-align: center;
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }

    h3 {
      margin: 24px 0 12px 0;
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      /* Cleaner look */
      letter-spacing: 1.2px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h3::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--glass-border);
    }

    /* Inputs */
    .input-group {
      margin-bottom: 16px;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      color: var(--text-main);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      outline: none;
    }

    input::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
    }

    input:focus {
      border-color: var(--accent-primary);
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
      box-shadow: 0 8px 12px -1px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-main);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .btn-google {
      background: white;
      color: #1f2937;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .btn-google:hover {
      background: #f9fafb;
    }

    .btn-google img {
      height: 20px;
      width: 20px;
    }

    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 13px;
      margin: 24px 0;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--glass-border);
    }

    /* Grid & Selection Buttons */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .select-btn {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-align: center;
    }

    .select-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
      transform: translateY(-2px);
    }

    .select-btn.selected {
      background: rgba(59, 130, 246, 0.2);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      font-weight: 600;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
    }

    /* Result Box */
    #result {
      margin-top: 24px;
      padding: 24px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-secondary);
      /* Success-ish color */
    }

    /* Responsive */
    @media (max-width: 600px) {
      .page {
        padding: 24px;
        margin: 16px;
      }

      h2 {
        font-size: 24px;
      }
    }
  </style>
</head>

<body>

  <!-- LOGIN PAGE -->
  <div id="pageLogin" class="page active">
    <h2>Welcome Back</h2>
    <div class="input-group">
      <input type="text" id="loginEmail" placeholder="Email address" autocomplete="email">
    </div>
    <div class="input-group">
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
    </div>

    <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>

    <div class="divider"><span>or</span></div>

    <div id="g_id_onload" data-client_id="" data-callback="handleCredentialResponse" data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
      data-text="continue_with" data-size="large" data-logo_alignment="left" data-width="100%">
    </div>

    <div style="margin-top: 24px; text-align: center;">
      <span style="color: var(--text-muted); font-size: 14px;">Don't have an account?</span>
      <button class="btn btn-secondary" onclick="goToSignup()" style="margin-top: 8px;">Create account</button>
    </div>
  </div>

  <!-- SIGNUP PAGE -->
  <div id="pageSignup" class="page">
    <h2>Create Account</h2>
    <div class="input-group">
      <input type="text" id="signupName" placeholder="Full name" autocomplete="name">
    </div>
    <div class="input-group">
      <input type="text" id="signupEmail" placeholder="Email address" autocomplete="email">
    </div>
    <div class="input-group">
      <input type="password" id="signupPassword" placeholder="Create password" autocomplete="new-password">
    </div>

    <button class="btn btn-primary" onclick="handleSignup()">Sign Up</button>

    <div class="divider"><span>or</span></div>

    <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline" data-text="signup_with"
      data-size="large" data-logo_alignment="left" data-width="100%">
    </div>

    <div style="margin-top: 24px; text-align: center;">
      <span style="color: var(--text-muted); font-size: 14px;">Already have an account?</span>
      <button class="btn btn-secondary" onclick="showLogin()" style="margin-top: 8px;">Sign In</button>
    </div>
  </div>

  <!-- PAGE 1 (Team Name) -->
  <div id="page1" class="page">
    <h2>Team Setup</h2>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">Enter your team name to get started.
    </p>
    <div class="input-group">
      <input type="text" id="teamName" placeholder="e.g. The Avengers">
    </div>
    <button class="btn btn-primary" onclick="goToPage(2)">Continue to Bids</button>
  </div>

  <!-- PAGE 2 (Bids) -->
  <div id="page2" class="page wide">
    <h2>Select Bids</h2>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">Must select at least 4 items.</p>
    <div id="bidGrids"></div>
    <div style="margin-top: 32px; display: flex; justify-content: flex-end;">
      <button class="btn btn-primary" style="width: auto; padding-left: 32px; padding-right: 32px;"
        onclick="goToPage(3)">Next Step</button>
    </div>
  </div>

  <!-- PAGE 3 (Datasets) -->
  <div id="page3" class="page wide">
    <h2>Select Datasets</h2>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">Choose exactly 5 datasets to test
      against.</p>
    <div id="datasetButtons" class="grid"></div>
    <div style="margin-top: 32px; display: flex; justify-content: flex-end;">
      <button class="btn btn-primary" style="width: auto; padding-left: 32px; padding-right: 32px;"
        onclick="goToPage(4)">Next Step</button>
    </div>
  </div>

  <!-- PAGE 4 (Credits) -->
  <div id="page4" class="page">
    <h2>Final Details</h2>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">Enter your remaining credits.</p>
    <div class="input-group">
      <input type="number" id="credits" placeholder="Credits (0-100)">
    </div>
    <button class="btn btn-primary" onclick="goToPage(5)">Calculate Score</button>
  </div>

  <!-- PAGE 5 (Results) -->
  <div id="page5" class="page">
    <h2>Simulation Complete</h2>
    <div id="result">Calculating...</div>
    <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 24px;">Start Over</button>
  </div>

  <script>
    // -------- CONFIG --------
    const API_URL = 'http://localhost:5000/api'; // Corrected port

    // -------- DATA --------
    const tiers = [
      {
        title: "Tier 1 – Elite", items: [
          { name: "TimSort", scores: [9, 9, 10, 8, 9, 8, 9, 7, 9, 9] },
          { name: "Merge Sort", scores: [9, 9, 8, 8, 9, 7, 9, 7, 8, 9] },
          { name: "Quick Sort", scores: [9, 9, 7, 5, 8, 7, 9, 7, 8, 8] },
          { name: "Heap Sort", scores: [8, 8, 7, 7, 8, 6, 8, 6, 7, 8] },
          { name: "Intro Sort", scores: [9, 9, 8, 7, 9, 7, 9, 7, 8, 9] },
          { name: "Dual Pivot Quick", scores: [8, 9, 7, 6, 8, 7, 9, 6, 8, 8] },
          { name: "Block Sort", scores: [8, 8, 7, 7, 8, 6, 8, 6, 7, 8] },
          { name: "Smooth Sort", scores: [7, 8, 8, 7, 7, 6, 7, 6, 6, 7] },
          { name: "Library Sort", scores: [8, 8, 7, 7, 8, 6, 8, 6, 7, 8] },
          { name: "Grail Sort", scores: [8, 8, 7, 7, 8, 6, 8, 6, 7, 7] }
        ]
      },
      {
        title: "Tier 2 – Strong", items: [
          { name: "Radix Sort", scores: [8, 9, 7, 7, 9, 10, 9, 2, 1, 8] },
          { name: "Counting Sort", scores: [7, 8, 6, 6, 9, 10, 2, 1, 1, 7] },
          { name: "Bucket Sort", scores: [8, 8, 7, 7, 6, 6, 5, 9, 2, 7] },
          { name: "Flash Sort", scores: [7, 8, 6, 6, 7, 6, 6, 4, 3, 7] },
          { name: "Pigeonhole Sort", scores: [6, 7, 5, 5, 8, 9, 1, 1, 1, 6] },
          { name: "Spread Sort", scores: [8, 8, 7, 7, 8, 7, 8, 4, 4, 8] },
          { name: "American Flag", scores: [7, 8, 6, 6, 7, 8, 7, 2, 1, 7] },
          { name: "Cartesian Tree", scores: [6, 6, 6, 5, 6, 5, 6, 4, 4, 6] },
          { name: "Strand Sort", scores: [7, 6, 7, 5, 6, 5, 6, 4, 5, 6] },
          { name: "Comb Sort", scores: [6, 5, 6, 5, 6, 5, 6, 4, 5, 6] }
        ]
      },
      {
        title: "Tier 3 – Basic", items: [
          { name: "Insertion Sort", scores: [8, 2, 9, 3, 6, 6, 2, 4, 5, 6] },
          { name: "Selection Sort", scores: [6, 2, 6, 3, 5, 5, 2, 3, 4, 5] },
          { name: "Bubble Sort", scores: [6, 1, 7, 2, 5, 5, 1, 3, 4, 5] },
          { name: "Shell Sort", scores: [7, 5, 7, 6, 6, 6, 5, 5, 6, 7] },
          { name: "Cocktail Sort", scores: [6, 1, 7, 2, 5, 5, 1, 3, 4, 5] },
          { name: "Gnome Sort", scores: [6, 1, 7, 2, 5, 5, 1, 3, 4, 5] },
          { name: "Odd-Even Sort", scores: [6, 2, 6, 3, 5, 5, 2, 3, 4, 5] },
          { name: "Cycle Sort", scores: [6, 3, 6, 4, 5, 5, 3, 3, 4, 5] },
          { name: "Pancake Sort", scores: [6, 2, 6, 3, 5, 5, 2, 3, 4, 5] },
          { name: "Tree Sort", scores: [7, 4, 6, 4, 6, 5, 4, 4, 5, 6] }
        ]
      },
      {
        title: "Tier 4 – Wildcards", items: [
          { name: "Bogo Sort", scores: [2, 0, 3, 1, 2, 1, 0, 0, 0, 1] },
          { name: "Bozo Sort", scores: [2, 0, 3, 1, 2, 1, 0, 0, 0, 1] },
          { name: "Stalin Sort", scores: [4, 1, 6, 2, 3, 3, 1, 2, 2, 3] },
          { name: "Sleep Sort", scores: [3, 1, 3, 2, 2, 2, 1, 1, 0, 2] },
          { name: "Miracle Sort", scores: [1, 0, 10, 0, 1, 1, 0, 0, 0, 1] },
          { name: "Slow Sort", scores: [3, 1, 4, 2, 3, 2, 1, 1, 1, 2] },
          { name: "Stooge Sort", scores: [3, 1, 4, 2, 3, 2, 1, 1, 1, 2] },
          { name: "Thanos Sort", scores: [4, 1, 4, 2, 3, 2, 1, 1, 1, 3] },
          { name: "Quantum Bogo", scores: [1, 0, 2, 0, 1, 0, 0, 0, 0, 0] },
          { name: "Intelligent Design", scores: [2, 0, 3, 1, 2, 1, 0, 0, 0, 1] }
        ]
      }
    ];

    const datasets = [
      "Small Random", "Large Random", "Nearly Sorted", "Reverse Sorted",
      "Many Duplicates", "Small Range", "Wide Range", "Floating Data",
      "Strings", "Mixed Size"
    ];

    // -------- STATE --------
    let selectedBids = [];
    let selectedData = [];

    // -------- NAVIGATION --------
    function goToPage(n) {
      // Check auth
      if (typeof n === 'number' && n !== 1 && !isAuthenticated()) {
        alert('Please sign in first.');
        showLogin();
        return;
      }
      // Validate steps
      if (n === 3 && !validateBids()) return;
      if (n === 4 && selectedData.length !== 5) {
        alert("Please select exactly 5 datasets.");
        return;
      }

      // Switch pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const targetId = (typeof n === 'number') ? ('page' + n) : ('page' + n);
      const el = document.getElementById(targetId);
      if (el) el.classList.add('active');

      // Trigger renders / actions
      if (n === 2) renderBids();
      if (n === 3) renderDatasets();
      if (n === 5) showResult();
    }

    function showLogin() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('pageLogin').classList.add('active');
    }
    function goToSignup() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('pageSignup').classList.add('active');
    }

    // -------- AUTH --------
    function saveToken(token) { localStorage.setItem('cld_token', token); }
    function getToken() { return localStorage.getItem('cld_token'); }
    function isAuthenticated() { return !!getToken(); }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) return alert('Please enter email and password');

      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.ok && data.token) {
          saveToken(data.token);
          goToPage(1);
        } else {
          alert(data.error || 'Login failed');
        }
      } catch (e) { console.error(e); alert('Connection error'); }
    }

    async function handleSignup() {
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      if (!email || !password) return alert('Please fill in all fields');

      try {
        const res = await fetch(`${API_URL}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        const data = await res.json();
        if (data.ok) {
          alert('Account created! Please sign in.');
          showLogin();
          document.getElementById('loginEmail').value = email;
        } else {
          alert(data.error || 'Signup failed');
        }
      } catch (e) { console.error(e); alert('Connection error'); }
    }

    // -------- APP LOGIC --------
    function renderBids() {
      const container = document.getElementById("bidGrids");
      if (container.innerHTML !== "") return; // Don't re-render if already there
      let html = "";
      tiers.forEach((tier, ti) => {
        html += `<h3>${tier.title}</h3><div class="grid">`;
        tier.items.forEach((itm, ii) => {
          const id = `bid-${ti}-${ii}`;
          html += `<div id="${id}" class="select-btn" onclick="toggleBid('${id}',${ti},${ii})">${itm.name}</div>`;
        });
        html += `</div>`;
      });
      container.innerHTML = html;
    }

    function toggleBid(id, tier, item) {
      const idx = selectedBids.findIndex(b => b.id === id);
      const el = document.getElementById(id);
      if (idx >= 0) {
        selectedBids.splice(idx, 1);
        el.classList.remove("selected");
      } else {
        selectedBids.push({ id, tier, item });
        el.classList.add("selected");
      }
    }

    function validateBids() {
      if (selectedBids.length < 4) {
        alert("Please select at least 4 algorithms.");
        return false;
      }
      return true;
    }

    function renderDatasets() {
      const container = document.getElementById("datasetButtons");
      if (container.innerHTML !== "") return;
      let html = "";
      datasets.forEach(d => {
        // using name as ID for simplicity
        html += `<div id="ds-${d}" class="select-btn" onclick="toggleData('${d}')">${d}</div>`;
      });
      container.innerHTML = html;
    }

    function toggleData(d) {
      const el = document.getElementById(`ds-${d}`);
      if (selectedData.includes(d)) {
        selectedData = selectedData.filter(x => x !== d);
        el.classList.remove("selected");
      } else {
        if (selectedData.length >= 5) {
          alert("You can only choose 5 datasets.");
          return;
        }
        selectedData.push(d);
        el.classList.add("selected");
      }
    }

    async function showResult() {
      const creds = parseInt(document.getElementById("credits").value) || 0;
      let total = 0;

      // Calculate score locally
      selectedBids.forEach(b => {
        const scores = tiers[b.tier].items[b.item].scores;
        selectedData.forEach(ds => {
          total += scores[datasets.indexOf(ds)];
        });
      });

      const finalScore = (creds / 100) + total;
      const resultEl = document.getElementById("result");
      resultEl.innerText = `Score: ${finalScore.toFixed(2)} — Saving...`;

      try {
        const teamName = document.getElementById('teamName').value || 'Unnamed';
        const payload = { teamName, selectedBids, selectedData, credits: creds, score: finalScore };
        const token = getToken();

        const res = await fetch(`${API_URL}/submit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.ok) {
          resultEl.innerHTML = `Final Score: <span style="color:var(--accent-primary)">${finalScore.toFixed(2)}</span><br><span style="font-size:14px;color:var(--text-muted)">Saved successfully</span>`;
        } else {
          resultEl.innerText = `Score: ${finalScore.toFixed(2)} (Save failed)`;
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = `Score: ${finalScore.toFixed(2)} (Error saving)`;
      }
    }
  </script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // -------- GOOGLE AUTH --------
    function handleCredentialResponse(response) {
      // Send ID token to backend
      fetch(`${API_URL}/google-signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken: response.credential })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.token) {
            saveToken(data.token);
            goToPage(1);
          } else {
            alert('Google Sign-In failed on server.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Google Sign-In error.');
        });
    }

    window.onload = function () {
      // Fetch Client ID from backend so we don't hardcode it
      fetch(`${API_URL}/config`)
        .then(r => r.json())
        .then(cfg => {
          const clientId = cfg.googleClientId;
          if (clientId) {
            // Initialize Google Identity
            google.accounts.id.initialize({
              client_id: clientId,
              callback: handleCredentialResponse
            });
            // Render buttons
            google.accounts.id.renderButton(
              document.querySelector('#pageLogin .g_id_signin'),
              { theme: 'outline', size: 'large', width: '100%' }
            );
            google.accounts.id.renderButton(
              document.querySelector('#pageSignup .g_id_signin'),
              { theme: 'outline', size: 'large', width: '100%' }
            );
          } else {
            console.warn('No Google Client ID found from backend.');
          }
        })
        .catch(err => console.error('Failed to load config:', err));
    };
  </script>
</body>

</html>